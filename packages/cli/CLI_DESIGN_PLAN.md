# DbRheo CLI 设计规划文档

## 项目愿景

DbRheo CLI 致力于打造一个专业、简洁的数据库智能助手终端界面。通过合理使用Rich库的基础功能，为用户提供清晰、高效的交互体验，专注于数据库操作的可视化展示。

## 核心技术栈

### 主要依赖
- **rich** (13.7.1+) - 富文本渲染（仅使用基础功能）
- **pygments** (2.17.2+) - 语法高亮
- **click** - 命令行参数处理

### 补充依赖
- **readline** - 命令历史支持（Python内置）

### 移除的依赖
- ~~prompt-toolkit~~ - 与Rich可能冲突，使用内置input即可
- ~~textual~~ - 过度设计，不需要复杂TUI
- ~~aiofiles~~ - 暂不需要
- ~~pyyaml~~ - 配置简单，暂不需要

## 架构设计

### 目录结构
```
packages/cli/
├── src/
│   ├── dbrheo_cli/
│   │   ├── __init__.py
│   │   ├── main.py              # CLI主入口
│   │   ├── app/                 # 应用核心
│   │   │   ├── __init__.py
│   │   │   ├── cli.py           # CLI主类（对应chat_cli.py的DbRheoCLI）
│   │   │   └── config.py        # CLI配置管理
│   │   ├── handlers/            # 事件处理器
│   │   │   ├── __init__.py
│   │   │   ├── event_handler.py # 处理核心事件流
│   │   │   ├── tool_handler.py  # 工具调用处理
│   │   │   └── input_handler.py # 用户输入处理
│   │   └── ui/                  # UI层
│   │       ├── __init__.py
│   │       ├── console.py       # Rich Console管理
│   │       ├── messages.py      # 消息显示组件
│   │       ├── tools.py         # 工具显示组件
│   │       └── streaming.py     # 流式输出处理
│   └── tests/                   # 测试文件
├── pyproject.toml              # 项目配置
└── README.md                   # 项目说明
```

## 功能规划（精简版）

### 第一阶段：核心功能（已完成）

#### 1.0 基础框架
- [x] 命令行参数解析（--log、--db-file等）
- [x] 日志系统初始化
- [x] 信号处理（graceful shutdown）
- [x] 环境变量读取

#### 1.1 基础Rich集成
- [x] 使用Rich Console替换print
- [x] 实现基础颜色（不超过5种）
- [x] 简单的文本格式化
- [x] 基础错误显示

#### 1.2 消息类型区分
- [x] 用户消息：简单前缀 "> "
- [x] AI响应：使用不同颜色
- [x] 系统消息：使用dim样式
- [x] 错误消息：红色高亮

#### 1.3 代码显示优化
- [x] SQL语法高亮
- [x] 表格使用Rich Table
- [x] 代码块基础高亮

### 第二阶段：流式输出和工具显示（已完成）

#### 2.1 流式输出
- [x] 基础流式显示（无需打字机效果）
- [x] 简单的缓冲机制
- [x] 直接输出避免闪烁

#### 2.2 工具状态显示
- [x] 简单的状态指示器（支持国际化）
- [x] 工具名称和参数显示
- [x] 执行结果展示

#### 2.3 确认机制
- [x] 清晰的确认提示
- [x] 1/2/confirm/cancel输入处理
- [x] 显示将执行的操作

### 第三阶段：基础交互优化（已完成）

#### 3.1 输入改进
- [x] 命令历史（使用readline）
- [x] 基础的Ctrl+C处理
- [x] 简单的命令解析（/exit, /help, /clear等）
- [x] DEBUG模式切换（/debug 0-5）
- [x] 多行输入支持（```或<<<标记）
- [x] ESC键中止输出功能

#### 3.2 显示优化
- [x] 表格结果自动美化（使用Rich Table）
- [x] 智能结果截断（默认20行，可配置）
- [x] 代码块语法高亮（支持SQL、Python等）
- [x] AI响应前缀标识

## 实现改进

### 新增特性
- **国际化支持**：创建i18n.py统一管理所有显示文本
- **常量管理**：创建constants.py集中管理硬编码值
- **灵活配置**：支持环境变量和运行时配置更新
- **工具结果显示**：自动展示工具执行结果
- **代码参数显示**：执行前展示即将执行的代码
- **流式代码块检测**：自动识别并格式化Markdown代码块

### 移除的功能
- 复杂的Panel/Layout系统（删除了layout.py）
- 动画效果和进度条
- prompt-toolkit集成
- 主题系统
- 自动补全
- 复杂的快捷键
- 配置文件系统

## UI设计规范（简化版）

### 颜色使用（仅5种）
```python
# 核心颜色
DEFAULT = "default"     # 普通文本
SUCCESS = "green"       # 成功/完成
ERROR = "red"          # 错误/失败  
WARNING = "yellow"      # 警告/确认
INFO = "cyan"          # 工具/信息

# SQL语法高亮使用Pygments默认配色
```

### 状态指示器
```python
# 工具状态（国际化）
status_pending = "[待定]"
status_running = "[执行中]"
status_success = "[成功]"
status_error = "[错误]"
status_confirm = "[确认]"

# 消息前缀
USER = "> "          # 用户输入
AGENT = "● "         # AI响应
SYSTEM = ""          # 系统消息（使用dim样式）
TOOL = ""            # 工具输出（在结果框内显示）
```

### 显示原则
1. **垂直流式布局** - 简单的上下排列
2. **最小化装饰** - 只在必要时使用分隔线
3. **专注内容** - 内容优先于形式
4. **快速响应** - 避免复杂渲染

## 实现要点

### 性能原则
- 使用Rich Live仅用于流式输出
- 大结果简单分页（每页50行）
- 避免全屏重绘
- 及时清理输出缓冲

### 与后端集成要点
1. **事件处理完整性**
   - 必须处理：Content, ToolCallRequest, Error, AwaitingConfirmation
   - 可选处理：Thought（根据调试模式）
   - 系统事件：max_session_turns, chat_compressed

2. **确认流程关键点**
   - AwaitingConfirmation后等待用户输入
   - 确认后发送"Please continue."继续处理
   - 维护pending_confirmations状态

3. **工具调度器集成**
   - 注册on_tool_calls_update回调
   - 监听工具状态变化（validating→scheduled→executing→success/error）
   - 在success状态时显示result_display内容
   - 支持并发工具执行

## 实施计划（简化版）

### 第一周：基础实现
- 实现app/cli.py主框架
- 完成event_handler.py核心功能
- 基础消息显示

### 第二周：功能完善
- 工具状态显示
- 确认机制
- 基础命令处理

### 第三周：优化调试
- 性能优化
- 错误处理完善
- 与后端联调

## 关键实现细节

### 已解决的问题
1. **事件处理完整性** - 实现了所有核心事件类型的处理
2. **确认流程连续性** - "Please continue."机制正确实现
3. **流式输出** - 代码块实时检测和格式化
4. **环境变量支持** - 动态读取和更新调试级别
5. **工具调用统计** - 实现了工具调用计数和显示
6. **文本国际化** - 所有显示文本支持多语言切换
7. **硬编码消除** - 基于内容格式而非工具名称的显示逻辑
8. **导入错误修复** - 所有模块正确导入依赖
9. **退出机制强化** - /exit和Ctrl+C确保100%退出
10. **工具结果展示** - 自动显示SQL查询结果和其他工具输出
11. **日志级别控制** - 统一使用log_info而非print
12. **Windows多行输入优化** - 添加剪贴板检测支持（2025-07-22）
13. **增强布局提示优化** - 简化操作提示，移除冗余标题（2025-07-22）

### 与chat_cli.py的差异
- 使用Rich替代普通print
- 模块化的事件处理
- 更清晰的UI层分离
- 保持核心功能不变

## 开发规范

### 代码原则
- 简单优先（KISS原则）
- 避免过度抽象
- 保持与现有chat_cli.py功能对等
- 类型注解完整

### 质量要求
- 每个模块独立可测试
- 错误处理完善
- 性能可接受（响应时间<100ms）

---

## 待完成任务

1. 创建pyproject.toml配置文件
2. 编写单元测试
3. 完善README文档
4. Linux/Mac平台的ESC键支持
5. 完成多语言支持（见下方详细计划）

---

## 多语言支持优化计划（2025-07-23）

### 设计原则
- **最小侵入性**：充分利用现有 i18n 框架，避免大规模重构
- **灵活性优先**：支持动态语言切换，不需要重启程序
- **统一管理**：所有显示文本集中在 i18n.py 中管理

### 实施阶段

#### 第一阶段：基础设施（已完成）✅
1. **语言自动检测**：基于系统 locale 自动选择语言
2. **语言切换命令**：实现 `/lang` 命令支持运行时切换
3. **核心文本 i18n 化**：替换关键的硬编码文本

#### 第二阶段：全面文本收集（已完成）✅
1. **CLI 界面文本**
   - [x] 所有 print/console.print 中的硬编码中文
   - [x] 错误消息和提示信息
   - [x] 调试输出（主要部分）
   
2. **UI 组件文本**
   - [x] 输入提示（剪贴板提示、多行模式提示）
   - [x] 启动画面提示
   - [x] 工具确认界面
   - [x] 状态显示
   
3. **系统消息**
   - [x] 文件操作提示
   - [x] 工具执行消息
   - [x] 各种状态和错误提示

#### 第三阶段：日文支持（计划中）📋
1. **创建日文语言包**（ja_JP）
2. **批量翻译**：收集完所有文本后统一翻译
3. **特殊处理**
   - 全角/半角数字输入兼容
   - 日文特有的提示优化

### 需要 i18n 化的文件清单

#### 高优先级（用户直接可见）
- [x] `handlers/input_handler.py` - 多行输入提示
- [x] `ui/simple_multiline_input.py` - 剪贴板提示
- [x] `ui/startup.py` - 启动画面（包括提示列表）
- [x] `ui/tools.py` - 工具确认界面（"日语系统请输入半角数字"）
- [x] `ui/messages.py` - 消息显示（工具执行提示）
- [x] `main.py` - 主目录运行警告
- [x] `ui/streaming.py` - 流式输出提示（无需处理，已确认无硬编码中文）

#### 中优先级（错误和状态）
- [x] `app/cli.py` - 退出提示、调试警告等（完成7处修改）
- [x] `handlers/event_handler.py` - 事件处理消息（已完成）
- [x] `handlers/tool_handler.py` - 工具处理消息（完成8处修改）

#### 低优先级（调试信息）
- [ ] 各种 log_info 中的调试信息
- [ ] 异常消息（根据需要）

### 实施策略

1. **分批处理**：按优先级逐步替换，确保每次修改都能正常工作
2. **保留灵活性**：
   - 支持环境变量覆盖（改进设计：环境变量优先，未设置时使用i18n）
   - 保留原有的配置机制
3. **测试验证**：每个阶段完成后进行语言切换测试

### 实施成果（2025-07-23）

#### 已完成的i18n化工作

1. **CLI层文本国际化**（✅ 完成）
   - 新增约150个i18n键值对
   - 完成日语和英语语言包翻译
   - 移除了所有emoji符号（按要求）
   - 修复了参数名冲突问题（key -> param_key）

2. **工具输出文本收集**（✅ 完成）
   - 收集了约110个工具输出相关的硬编码中文文本
   - 涉及工具：database_connect_tool、schema_discovery、file_read_tool等
   - 已添加到i18n系统（但尚未应用）

3. **架构问题分析**（✅ 完成）
   - 发现问题：i18n.py在cli包，但工具在core包
   - 分析了9个文件的依赖关系
   - 评估了多种解决方案

### 待解决的架构问题（2025-07-24）

#### 问题描述
- **现状**：i18n.py位于cli包，包含大量CLI特定文本
- **需求**：core包中的工具需要国际化支持
- **冲突**：core包不应依赖cli包（违反分层架构）

#### 解决方案评估

**方案1：双层i18n系统**（推荐）
```python
# core包：基础i18n框架 + 工具文本
/packages/core/src/dbrheo/utils/i18n_base.py

# cli包：继承并扩展CLI特定文本  
/packages/cli/src/dbrheo_cli/i18n.py
```
- 优点：架构清晰，职责分离
- 缺点：需要重构现有代码

**方案2：工具返回结构化数据**
- 工具只返回数据，CLI层负责格式化
- 优点：完全解耦，符合"工具极简"原则
- 缺点：改动量大，影响现有功能

**方案3：保持现状**
- 暂时保留硬编码，等需求明确后重构
- 优点：无风险，保持稳定
- 缺点：工具输出无法国际化

### 下一步行动计划

1. **短期**（保持稳定）
   - 暂时保持工具输出的硬编码
   - 完善CLI层的多语言支持
   - 收集用户反馈

2. **中期**（架构优化）
   - 根据实际需求选择合适方案
   - 逐步实施架构调整
   - 确保向后兼容

3. **长期**（完整国际化）
   - 实现工具输出的完整国际化
   - 支持更多语言
   - 提供语言包扩展机制

---

**文档版本**: 4.4.0  
**最后更新**: 2025-07-24  
**作者**: DbRheo Team